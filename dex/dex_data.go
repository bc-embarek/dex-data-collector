package dex

import (
	"context"
	"github.com/deckarep/golang-set"
	"github.com/ethereum/go-ethereum"
	"github.com/ethereum/go-ethereum/accounts/abi"
	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/ethclient/gethclient"
	"log"
	"math"
	"math/big"
	"strings"
)

var (
	sender           common.Address
	contractAddress  common.Address
	contractBytecode string
	contractABI      abi.ABI
)

func init() {
	sender = common.HexToAddress("0x1000000000000000000000000000000000000001")
	contractAddress = common.HexToAddress("0x1000000000000000000000000000000000000002")
	contractBytecode = "0x608060405234801561001057600080fd5b50600436106100365760003560e01c80634a69ac501461003b578063d31b70031461006b575b600080fd5b610055600480360381019061005091906109d0565b61009b565b6040516100629190610cef565b60405180910390f35b6100856004803603810190610080919061097d565b6103e4565b6040516100929190610ccd565b60405180910390f35b60606000825167ffffffffffffffff8111156100ba576100b961101a565b5b6040519080825280602002602001820160405280156100f357816020015b6100e0610735565b8152602001906001900390816100d85790505b50905060005b83518110156103da57600084828151811061011757610116610feb565b5b602002602001015190508073ffffffffffffffffffffffffffffffffffffffff166306fdde036040518163ffffffff1660e01b815260040160006040518083038186803b15801561016757600080fd5b505afa92505050801561019d57506040513d6000823e3d601f19601f8201168201806040525081019061019a9190610a19565b60015b6101dc576101a9611049565b806308c379a014156101d057506101be6110a2565b806101c957506101d2565b50506103c7565b505b3d6000803e3d6000fd5b8173ffffffffffffffffffffffffffffffffffffffff166395d89b416040518163ffffffff1660e01b815260040160006040518083038186803b15801561022257600080fd5b505afa92505050801561025857506040513d6000823e3d601f19601f820116820180604052508101906102559190610a19565b60015b61029857610264611049565b806308c379a0141561028c57506102796110a2565b80610284575061028e565b5050506103c7565b505b3d6000803e3d6000fd5b8273ffffffffffffffffffffffffffffffffffffffff1663313ce5676040518163ffffffff1660e01b815260040160206040518083038186803b1580156102de57600080fd5b505afa92505050801561030f57506040513d601f19601f8201168201806040525081019061030c9190610a8f565b60015b6103505761031b611049565b806308c379a0141561034457506103306110a2565b8061033b5750610346565b505050506103c7565b505b3d6000803e3d6000fd5b604051806080016040528089878151811061036e5761036d610feb565b5b602002602001015173ffffffffffffffffffffffffffffffffffffffff1681526020018481526020018381526020018260ff168152508686815181106103b7576103b6610feb565b5b6020026020010181905250505050505b80806103d290610f73565b9150506100f9565b5080915050919050565b6060600084905060008173ffffffffffffffffffffffffffffffffffffffff1663574f2ba36040518163ffffffff1660e01b815260040160206040518083038186803b15801561043357600080fd5b505afa158015610447573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061046b9190610a62565b90506000819050848661047e9190610e3c565b8211156104945784866104919190610e3c565b90505b600086826104a29190610e92565b67ffffffffffffffff8111156104bb576104ba61101a565b5b6040519080825280602002602001820160405280156104f457816020015b6104e1610776565b8152602001906001900390816104d95790505b50905060008790505b828110156107265760008573ffffffffffffffffffffffffffffffffffffffff16631e3dd18b836040518263ffffffff1660e01b81526004016105409190610d11565b60206040518083038186803b15801561055857600080fd5b505afa15801561056c573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906105909190610950565b905060405180606001604052808273ffffffffffffffffffffffffffffffffffffffff1681526020018273ffffffffffffffffffffffffffffffffffffffff16630dfe16816040518163ffffffff1660e01b815260040160206040518083038186803b1580156105ff57600080fd5b505afa158015610613573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906106379190610950565b73ffffffffffffffffffffffffffffffffffffffff1681526020018273ffffffffffffffffffffffffffffffffffffffff1663d21220a76040518163ffffffff1660e01b815260040160206040518083038186803b15801561069857600080fd5b505afa1580156106ac573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906106d09190610950565b73ffffffffffffffffffffffffffffffffffffffff16815250838a846106f69190610e92565b8151811061070757610706610feb565b5b602002602001018190525050808061071e90610f73565b9150506104fd565b50809450505050509392505050565b6040518060800160405280600073ffffffffffffffffffffffffffffffffffffffff1681526020016060815260200160608152602001600060ff1681525090565b6040518060600160405280600073ffffffffffffffffffffffffffffffffffffffff168152602001600073ffffffffffffffffffffffffffffffffffffffff168152602001600073ffffffffffffffffffffffffffffffffffffffff1681525090565b60006107ec6107e784610d51565b610d2c565b9050808382526020820190508285602086028201111561080f5761080e611070565b5b60005b8581101561083f5781610825888261088b565b845260208401935060208301925050600181019050610812565b5050509392505050565b600061085c61085784610d7d565b610d2c565b90508281526020810184848401111561087857610877611075565b5b610883848285610f0f565b509392505050565b60008135905061089a81611138565b92915050565b6000815190506108af81611138565b92915050565b600082601f8301126108ca576108c961106b565b5b81356108da8482602086016107d9565b91505092915050565b600082601f8301126108f8576108f761106b565b5b8151610908848260208601610849565b91505092915050565b6000813590506109208161114f565b92915050565b6000815190506109358161114f565b92915050565b60008151905061094a81611166565b92915050565b6000602082840312156109665761096561107f565b5b6000610974848285016108a0565b91505092915050565b6000806000606084860312156109965761099561107f565b5b60006109a48682870161088b565b93505060206109b586828701610911565b92505060406109c686828701610911565b9150509250925092565b6000602082840312156109e6576109e561107f565b5b600082013567ffffffffffffffff811115610a0457610a0361107a565b5b610a10848285016108b5565b91505092915050565b600060208284031215610a2f57610a2e61107f565b5b600082015167ffffffffffffffff811115610a4d57610a4c61107a565b5b610a59848285016108e3565b91505092915050565b600060208284031215610a7857610a7761107f565b5b6000610a8684828501610926565b91505092915050565b600060208284031215610aa557610aa461107f565b5b6000610ab38482850161093b565b91505092915050565b6000610ac88383610c03565b60608301905092915050565b6000610ae08383610c45565b905092915050565b610af181610ec6565b82525050565b6000610b0282610dce565b610b0c8185610e09565b9350610b1783610dae565b8060005b83811015610b48578151610b2f8882610abc565b9750610b3a83610def565b925050600181019050610b1b565b5085935050505092915050565b6000610b6082610dd9565b610b6a8185610e1a565b935083602082028501610b7c85610dbe565b8060005b85811015610bb85784840389528151610b998582610ad4565b9450610ba483610dfc565b925060208a01995050600181019050610b80565b50829750879550505050505092915050565b6000610bd582610de4565b610bdf8185610e2b565b9350610bef818560208601610f0f565b610bf881611084565b840191505092915050565b606082016000820151610c196000850182610ae8565b506020820151610c2c6020850182610ae8565b506040820151610c3f6040850182610ae8565b50505050565b6000608083016000830151610c5d6000860182610ae8565b5060208301518482036020860152610c758282610bca565b91505060408301518482036040860152610c8f8282610bca565b9150506060830151610ca46060860182610cbe565b508091505092915050565b610cb881610ef8565b82525050565b610cc781610f02565b82525050565b60006020820190508181036000830152610ce78184610af7565b905092915050565b60006020820190508181036000830152610d098184610b55565b905092915050565b6000602082019050610d266000830184610caf565b92915050565b6000610d36610d47565b9050610d428282610f42565b919050565b6000604051905090565b600067ffffffffffffffff821115610d6c57610d6b61101a565b5b602082029050602081019050919050565b600067ffffffffffffffff821115610d9857610d9761101a565b5b610da182611084565b9050602081019050919050565b6000819050602082019050919050565b6000819050602082019050919050565b600081519050919050565b600081519050919050565b600081519050919050565b6000602082019050919050565b6000602082019050919050565b600082825260208201905092915050565b600082825260208201905092915050565b600082825260208201905092915050565b6000610e4782610ef8565b9150610e5283610ef8565b9250827fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff03821115610e8757610e86610fbc565b5b828201905092915050565b6000610e9d82610ef8565b9150610ea883610ef8565b925082821015610ebb57610eba610fbc565b5b828203905092915050565b6000610ed182610ed8565b9050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000819050919050565b600060ff82169050919050565b60005b83811015610f2d578082015181840152602081019050610f12565b83811115610f3c576000848401525b50505050565b610f4b82611084565b810181811067ffffffffffffffff82111715610f6a57610f6961101a565b5b80604052505050565b6000610f7e82610ef8565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff821415610fb157610fb0610fbc565b5b600182019050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b600060033d11156110685760046000803e611065600051611095565b90505b90565b600080fd5b600080fd5b600080fd5b600080fd5b600080fd5b6000601f19601f8301169050919050565b60008160e01c9050919050565b600060443d10156110b257611135565b6110ba610d47565b60043d036004823e80513d602482011167ffffffffffffffff821117156110e2575050611135565b808201805167ffffffffffffffff8111156111005750505050611135565b80602083010160043d03850181111561111d575050505050611135565b61112c82602001850186610f42565b82955050505050505b90565b61114181610ec6565b811461114c57600080fd5b50565b61115881610ef8565b811461116357600080fd5b50565b61116f81610f02565b811461117a57600080fd5b5056fea2646970667358221220ddd8fb6534098159673eee05ad9301936e0d12c27f6a4bdfeeb611d15fd8d23f64736f6c63430008070033"
	abiStr := "[{\"inputs\": [{\"internalType\": \"address\", \"name\": \"_factory\", \"type\": \"address\"}, {\"internalType\": \"uint256\", \"name\": \"start\", \"type\": \"uint256\"}, {\"internalType\": \"uint256\", \"name\": \"size\", \"type\": \"uint256\"}], \"name\": \"getPoolAddresses\", \"outputs\": [{\"components\": [{\"internalType\": \"address\", \"name\": \"addr\", \"type\": \"address\"}, {\"internalType\": \"address\", \"name\": \"token0\", \"type\": \"address\"}, {\"internalType\": \"address\", \"name\": \"token1\", \"type\": \"address\"}], \"internalType\": \"struct DataCollector.Pool[]\", \"name\": \"\", \"type\": \"tuple[]\"}], \"stateMutability\": \"view\", \"type\": \"function\"}, {\"inputs\": [{\"internalType\": \"address[]\", \"name\": \"_tokens\", \"type\": \"address[]\"}], \"name\": \"getTokenInfo\", \"outputs\": [{\"components\": [{\"internalType\": \"address\", \"name\": \"addr\", \"type\": \"address\"}, {\"internalType\": \"string\", \"name\": \"name\", \"type\": \"string\"}, {\"internalType\": \"string\", \"name\": \"symbol\", \"type\": \"string\"}, {\"internalType\": \"uint8\", \"name\": \"decimal\", \"type\": \"uint8\"}], \"internalType\": \"struct DataCollector.Token[]\", \"name\": \"\", \"type\": \"tuple[]\"}], \"stateMutability\": \"view\", \"type\": \"function\"}]"
	contractABI, _ = abi.JSON(strings.NewReader(abiStr))
}

type Token struct {
	Address  common.Address
	Name     string
	Symbol   string
	Decimals uint8
}

type Pair struct {
	Address       common.Address
	Token0Address common.Address
	Token1Address common.Address
	Token0        *Token
	Token1        *Token
}

type Collector struct {
	GethClient *gethclient.Client
}

func (c *Collector) ethCall(callData []byte) ([]byte, error) {
	msg := ethereum.CallMsg{
		From: sender,
		To:   &contractAddress,
		Data: callData,
	}
	overrides := make(map[common.Address]gethclient.OverrideAccount, 2)
	overrides[sender] = gethclient.OverrideAccount{Balance: big.NewInt(int64(math.Pow(10, 18)))}
	overrides[contractAddress] = gethclient.OverrideAccount{Code: common.FromHex(contractBytecode)}
	return c.GethClient.CallContract(context.Background(), msg, nil, &overrides)
}

func (c *Collector) getPairs(factory common.Address, start int, pageSize int) []Pair {
	callData, err := contractABI.Pack("getPoolAddresses", factory, big.NewInt(int64(start)), big.NewInt(int64(pageSize)))
	if err != nil {
		log.Fatal("pack call data for getPoolAddresses error ", err)
	}
	results, err := c.ethCall(callData)
	if err != nil {
		log.Fatal("failed when eth_call: ", err)
	}
	var pairs []Pair
	if err := contractABI.UnpackIntoInterface(&pairs, "getPoolAddresses", results); err != nil {
		log.Fatal("unpack results error")
	}
	log.Printf("get %d pairs with start: %d", len(pairs), start)
	return pairs
}

func (c *Collector) getTokens(tokens []common.Address) []Token {
	callData, err := contractABI.Pack("getTokenInfo", tokens)
	if err != nil {
		log.Fatal("pack call data for getTokenInfo error ", err)
	}
	var tokenRes []Token
	if results, err := c.ethCall(callData); err != nil {
		if len(tokens) > 1 {
			tokenRes = append(tokenRes, c.getTokens(tokens[:len(tokens)/2])...)
			tokenRes = append(tokenRes, c.getTokens(tokens[len(tokens)/2:])...)
		}
	} else {
		if err = contractABI.UnpackIntoInterface(&tokenRes, "getTokenInfo", results); err != nil {
			log.Fatal("unpack token results error ", err)
		}
		log.Printf("get %d tokens", len(tokenRes))
	}
	return tokenRes
}

func (c *Collector) GetAllPairs(factory common.Address, tokenInfo bool) []Pair {
	// get all pairs
	start := 0
	pageSize := 1000
	pairs := c.getPairs(factory, start, pageSize)
	allPairs := pairs

	for len(pairs) == pageSize {
		start += pageSize
		pairs = c.getPairs(factory, start, pageSize)
		allPairs = append(allPairs, pairs...)
	}

	// get all tokenAddrs
	if tokenInfo {
		tokenSet := mapset.NewSet()
		for _, pair := range allPairs {
			tokenSet.Add(pair.Token0Address)
			tokenSet.Add(pair.Token1Address)
		}
		var tokenAddrs []common.Address
		for token := range tokenSet.Iterator().C {
			tokenAddrs = append(tokenAddrs, token.(common.Address))
		}
		tokens := c.getTokens(tokenAddrs)
		tokenMap := make(map[string]Token)
		for _, token := range tokens {
			tokenMap[token.Address.Hex()] = token
		}

		for idx, pair := range allPairs {
			if token, ok := tokenMap[pair.Token0Address.Hex()]; ok {
				pair.Token0 = &token
			}
			if token, ok := tokenMap[pair.Token1Address.Hex()]; ok {
				pair.Token1 = &token
			}
			allPairs[idx] = pair
		}
	}
	return allPairs
}
